/*create view that returns the names and ids of individuals who have not been fully*/ vaccinated - see fully_vaccinated_view*/
/*make positive_tests_count_view more complex - e.g include names of individuals and dates of positive tests, order by test date*/
/*create view determining compliance - sort individuals who are in compliance by ensuring that they hve not had a positive test in 14 days, reported any symptoms in 14 days, adn completed the training*/
/*create view to see if any reportd close contacts are umd individuals that have visited campus*/

CREATE VIEW PERSON_VIEW AS
SELECT name, age, affiliation, training status, DATETIME.
FROM  PERSON;
SELECT * FROM PERSON_VIEW;


CREATE VIEW VACCINATION_VIEW AS
SELECT vaccinated, vaccinated type, dose 1 DATETIME, dose 2 DATETIME,
FROM  VACCINATED;
SELECT * FROM VACCINATED_VIEW;

CREATE VIEW SYMPTOMS_VIEW AS
SELECT symptom_name,
FROM SYMPTOMS
SELECT * FROM SYMPTOMS_VIEW;


CREATE VIEW TESTING_VIEW AS
SELECT testing_id, univ_id, test_result,test_date,
FROM TESTING
SELECT * FROM TESTING_VIEW;


CREATE VIEW BUILDINGS_VIEW AS
SELECT building_id, building_name,
FROM BUILDINGS;
SELECT*FROM BUILDINGS_VIEW;


/*fully working*/
/*fully_vaccinated_view*/

/*alter table vaccination
drop column vaccination_name;*/

alter table vaccination
add column vaccination_name VARCHAR(15) after vaccination_type;

update vaccination
set vaccination_name = 'j&j' where vaccination_type = 3;

update vaccination
set vaccination_name = 'moderna' where vaccination_type = 2;

update vaccination
set vaccination_name = 'pfizer' where vaccination_type = 3;

DROP VIEW IF EXISTS fully_vaccinated_view;
CREATE VIEW fully_vaccinated_view AS
SELECT v.univ_id, sq.full_name, v.vaccination_name, v.dose_1_date, v.dose_2_date
from vaccination v
inner join
(select p.univ_id, concat(last_name,', ', first_name) as full_name 
from person p) sq
on v.univ_id = sq.univ_id
where v.vaccination_type is not null
and v.dose_2_date is not null or v.vaccination_type = 3
order by univ_id
;
SELECT * FROM fully_vaccinated_VIEW;


/*positive_tests_view*/
/*fully working*/
DROP VIEW IF EXISTS positive_tests_view;
create view positive_tests_view as
select t.univ_id, concat(p.last_name,', ', p.first_name) as full_name , test_date
from testing t
inner join person p
on t.univ_id = p.univ_id
where test_result =1
order by test_date
;
select * from positive_tests_view


/*recent_pos_tests_count_view*/
/*fully working*/
DROP VIEW IF EXISTS recent_pos_tests_count_view;
create view recent_pos_tests_count_view as
select count(t.test_result) as num_pos_test
from testing t
inner join person p
on t.univ_id = p.univ_id
where test_result =1 and test_date > '2021-04-15 05:00:00'
;
select * from recent_pos_tests_count_view;

/*not_full_vacc_count_view*/
/*fully working*/
DROP VIEW IF EXISTS not_full_vacc_count_view;
CREATE VIEW not_full_vacc_count_view as
select count(v.univ_id) as not_full_vacc_count
from vaccination v
where (v.dose_2_date is null and v.vaccination_type < 3) or v.vaccination_type != 3
;
select * from not_full_vacc_count_view;

/*not_full_vacc_percent_view*/
/*fully working*/
drop view if exists not_full_vacc_percent_view;
create view not_full_vacc_percent_view as
select (n.not_full_vacc_count/count(p.univ_id)) as not_full_vacc_percent
from not_full_vacc_count_view n 
left join person p
on n.not_full_vacc_count = p.univ_id
;

select * from not_full_vacc_percent_view;

/*fully working*/
/*close_contacts_view*/
drop view if exists close_contacts_view;
create view close_contacts_view as
select c.contact_person_id, c.univ_id as reporter_univ_id, concat(p.last_name, ', ', p.first_name) as reporter_full_name,  concat(r.contact_last_name, ', ', r.contact_first_name) as contact_full_name, r.contact_email
from close_contact_reports c
inner join person p
on p.univ_id = c.univ_id
inner join contact_report_people r
on c.contact_person_id = r.contact_person_id
;
